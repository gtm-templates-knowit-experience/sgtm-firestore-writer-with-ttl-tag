___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Firestore Writer with TTL",
  "categories": ["ANALYTICS", "DATA_WAREHOUSING", "UTILITY"],
  "brand": {
    "id": "brand_dummy",
    "displayName": "",
    "thumbnail": "data:image/png;base64,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\u003d\u003d"
  },
  "description": "Use this tag to write data to Firestore. With this template you can also write TTL (Time to Live) to Firestore directly from Server-side GTM.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "gcpProjectId",
    "displayName": "GCP Project ID",
    "simpleValueType": true,
    "help": "GCP Project ID can be found by visiting GCP page. In upper left corner click on dropdown, select GCP project where you want to set up Ecommerce Attributor and next to the project name you can find project ID.",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "TEXT",
    "name": "firebasePath",
    "displayName": "Firebase Path",
    "simpleValueType": true,
    "help": "The path to the document or collection. Must not start or end with a \u0027/\u0027.  If the path is to a collection, a document will be created with a randomly generated ID. If the path is to a document and it does not exist, it will be created.",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ]
  },
  {
    "type": "CHECKBOX",
    "name": "addEventData",
    "checkboxText": "Add Event Data",
    "simpleValueType": true,
    "help": "Add all Event Data to the document. If Event Data and Custom Data have the same field, the Custom Data value will be used for that field. In other words, you can override Event Data values with Custom Data."
  },
  {
    "type": "CHECKBOX",
    "name": "firebaseMerge",
    "checkboxText": "Merge document keys",
    "simpleValueType": true,
    "help": "If checked then merge the keys from the input into the document, otherwise the method will override the whole document."
  },
  {
    "type": "CHECKBOX",
    "name": "addTimestamp",
    "checkboxText": "Add Timestamp",
    "simpleValueType": true,
    "help": "This option will add the millisecond timestamp to the document."
  },
  {
    "type": "TEXT",
    "name": "timestampFieldName",
    "displayName": "Timestamp field name",
    "simpleValueType": true,
    "defaultValue": "timestamp",
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "type": "REGEX",
        "args": [
          "^[A-Za-z0-9_]*$"
        ]
      }
    ],
    "enablingConditions": [
      {
        "paramName": "addTimestamp",
        "paramValue": true,
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "CHECKBOX",
    "name": "addTimeToLive",
    "checkboxText": "Add Time to Live",
    "simpleValueType": true,
    "help": "Adds a Date and Time type value that can be used for deleting documents in Firestore based on expiry Date and Time."
  },
  {
    "type": "GROUP",
    "name": "timeToLiveGroup",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "TEXT",
        "name": "timeToLiveFieldName",
        "displayName": "Time to Live field name",
        "simpleValueType": true,
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          },
          {
            "type": "REGEX",
            "args": [
              "^[A-Za-z0-9_]*$"
            ]
          }
        ],
        "defaultValue": "time_to_live",
        "alwaysInSummary": true
      },
      {
        "type": "TEXT",
        "name": "timeToLiveDays",
        "displayName": "Time To Live",
        "simpleValueType": true,
        "help": "Delete document after X days using Time To Live policies.",
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          },
          {
            "type": "NON_NEGATIVE_NUMBER"
          }
        ],
        "defaultValue": 7,
        "alwaysInSummary": true,
        "valueUnit": "day(s)"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "addTimeToLive",
        "paramValue": true,
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "CHECKBOX",
    "name": "skipNilValues",
    "checkboxText": "Skip null or undefined values",
    "simpleValueType": true,
    "help": "This option allows skipping items from customDataList with undefined or null values."
  },
  {
    "type": "GROUP",
    "name": "customDataListGroup",
    "displayName": "Custom Data",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "customDataList",
        "simpleTableColumns": [
          {
            "defaultValue": "",
            "displayName": "Field Name",
            "name": "name",
            "type": "TEXT",
            "isUnique": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Field Value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "newRowButtonText": "Add property"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "logsGroup",
    "displayName": "Logs Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "RADIO",
        "name": "logType",
        "radioItems": [
          {
            "value": "no",
            "displayValue": "Do not log"
          },
          {
            "value": "debug",
            "displayValue": "Log to console during debug and preview"
          },
          {
            "value": "always",
            "displayValue": "Always log to console"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "debug"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

const JSON = require('JSON');
const getAllEventData = require('getAllEventData');
const getTimestampMillis = require('getTimestampMillis');
const getRequestHeader = require('getRequestHeader');
const getGoogleAuth = require('getGoogleAuth');
const sendHttpRequest = require('sendHttpRequest');
const getType = require('getType');
const logToConsole = require('logToConsole');
const getContainerVersion = require('getContainerVersion');
const Math = require('Math');
const Object = require('Object');
const makeInteger = require('makeInteger');
const encodeUriComponent = require('encodeUriComponent');

// —––––––––––––––––– CONSTANTS –––––––––––––––––—
const MS_PER_DAY = 86400000;
const MS_PER_HOUR = 3600000;
const MS_PER_MINUTE = 60000;

// Container & logging
const containerVersion = getContainerVersion();
const isDebug = containerVersion.debugMode;
const traceId = getRequestHeader('trace-id');
function determinateIsLoggingEnabled() {
  if (!data.logType) return isDebug;
  if (data.logType === 'no') return false;
  if (data.logType === 'debug') return isDebug;
  return data.logType === 'always';
}
const isLoggingEnabled = determinateIsLoggingEnabled();

// —––––––––––––––––– HELPERS –––––––––––––––––—
function pad(num, width) {
  let s = '' + num;
  while (s.length < width) {
    s = '0' + s;
  }
  return s;
}

/**
 * Build a Firestore‐valid ISO timestamp:
 *   ms since epoch → "YYYY-MM-DDTHH:mm:ss.SSSZ"
 */
function buildNumericIso(ts) {
  // time‐of‐day
  let msec = ts % MS_PER_DAY;
  const hour = Math.floor(msec / MS_PER_HOUR);
	msec = msec - hour * MS_PER_HOUR;
  const minute = Math.floor(msec / MS_PER_MINUTE);
	msec = msec - minute * MS_PER_MINUTE;
  const second = Math.floor(msec / 1000);
  const mill = msec - second * 1000;

  // days since 1970-01-01
  let days = Math.floor(ts / MS_PER_DAY);

  // subtract years
  let year = 1970;
  while (true) {
    const isLeap = (year % 4 === 0 && (year % 100 !== 0 || year % 400 === 0));
    const daysInYear = isLeap ? 366 : 365;
    if (days >= daysInYear) {
      days = days - daysInYear;
      year = year + 1;
    } else {
      break;
    }
  }

  // subtract months
  const monthLengths = [
    31,
    ((year % 4 === 0 && (year % 100 !== 0 || year % 400 === 0)) ? 29 : 28),
    31,30,31,30,31,31,30,31,30,31
  ];
  let monthIndex = 0;
  while (days >= monthLengths[monthIndex]) {
    days = days - monthLengths[monthIndex];
    monthIndex = monthIndex + 1;
  }

  const month = monthIndex + 1;
  const day   = days + 1;

  return (
    pad(year,4) + '-' + pad(month,2) + '-' + pad(day,2) +
    'T' +
    pad(hour,2)   + ':' + pad(minute,2) + ':' +
    pad(second,2) + '.' + pad(mill,3) + 'Z'
  );
}

/**
 * Wrap any JS value into Firestore REST JSON:
 *  - null       → { nullValue: null }
 *  - string     → { stringValue: ... }
 *  - number     → { doubleValue: ... }
 *  - boolean    → { booleanValue: ... }
 *  - array      → { arrayValue: { values: [...] } }
 *  - object     → { mapValue:   { fields: {...} } }
 */
function wrapValue(v) {
  if (v === null || v === undefined) {
    return { nullValue: null };
  }
  const t = getType(v);
  if (t === 'string') { return { stringValue:  v };}
  if (t === 'number') { return { doubleValue:  v };}
  if (t === 'boolean') { return { booleanValue: v };}
  if (t === 'array') {
    const vals = [];
    for (let i = 0; i < v.length; i = i + 1) {
      vals.push(wrapValue(v[i]));
    }
    return { arrayValue: { values: vals } };
  }
  if (t === 'object') {
    const flds = {};
    const keys = Object.keys(v);
    for (let i = 0; i < keys.length; i = i + 1) {
      const k = keys[i];
      flds[k] = wrapValue(v[k]);
    }
    return { mapValue: { fields: flds } };
  }
  return { nullValue: null };
}

// —––––––––––––––––– BUILD FIRESTORE FIELDS –––––––––––––––––—
const fields = {};

// 1) TTL as a true Firestore Timestamp
if (data.addTimeToLive) {
  const ttlDays  = makeInteger(data.timeToLiveDays);
  const expireMs = getTimestampMillis() + ttlDays * MS_PER_DAY;
  const isoTs = buildNumericIso(expireMs);

  fields[data.timeToLiveFieldName] = {
    timestampValue: isoTs
  };
}

// 2) Raw event timestamp
if (data.addTimestamp) {
  const now = getTimestampMillis();
  fields[data.timestampFieldName] = {
    integerValue: now.toString()
  };
}

// 3) Custom key/value list
if (data.customDataList) {
  data.customDataList.forEach(function(item) {
    const name = item.name;
    const val = item.value;
    if (data.skipNilValues && (val === null || val === undefined)) {
      return;
    }
    fields[name] = wrapValue(val);
  });
}

// 4) Full event payload
if (data.addEventData) {
  const all = getAllEventData();
  const keys = Object.keys(all);
  for (let i = 0; i < keys.length; i = i + 1) {
    const key = keys[i];
    if (fields[key] !== undefined) {
      continue;
    }
    fields[key] = wrapValue(all[key]);
  }
}

// —––––––––––––––––– FIRESTORE REST CALL –––––––––––––––––—
const payload = { fields: fields };
const projectId = data.gcpProjectId;
const rawPath = data.firebasePath;  // e.g. "myCollection" or "myCollection/12345"
const baseUrl   =
  'https://firestore.googleapis.com/v1/projects/' +
  projectId +
  '/databases/(default)/documents/' +
  rawPath;

let url, method;

// if user gave a full path (collection + ID)…
if (rawPath.indexOf('/') > -1) {
  // always PATCH to upsert
  url    = baseUrl;
  method = 'PATCH';

  if (data.firebaseMerge) {
    const fieldNames = Object.keys(fields);
    for (let i = 0; i < fieldNames.length; i = i + 1) {
      const fp = fieldNames[i];
      url = url + (i === 0 ? '?' : '&') + 
            'updateMask.fieldPaths=' + encodeUriComponent(fp);
    }
  }
}
// otherwise, no ID → POST to collection for an auto-generated ID
else {
  url    = baseUrl;
  method = 'POST';
}

const auth = getGoogleAuth({ scopes: ['https://www.googleapis.com/auth/datastore'] });

sendHttpRequest(
  url,
  {
    method: method,
    timeout: 500,
    headers: { 'Content-Type': 'application/json' },
    authorization: auth
  },
  JSON.stringify({ fields: fields })
).then(
  function(res) {
    if (isLoggingEnabled) {
      // parse response body (assumed valid JSON)
      const body = JSON.parse(res.body || '{}');
      let docId = '';
      if (body.name) {
        const parts = body.name.split('/');
        docId = parts[parts.length - 1];
      }
      logToConsole(
        JSON.stringify({
          Name: 'Firestore',
          Type: 'Message',
          TraceId: traceId,
          EventName: 'Write',
          DocumentId: docId,
          DocumentInput: fields
        })
      );
    }
    data.gtmOnSuccess();
  },
  function(err) {
    logToConsole('Firestore ' + method + ' failed: ' + err);
    data.gtmOnFailure();
  }
);
function determinateIsLoggingEnabled() {
  if (!data.logType) {
    return isDebug;
  }

  if (data.logType === 'no') {
    return false;
  }

  if (data.logType === 'debug') {
    return isDebug;
  }

  return data.logType === 'always';
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "headerWhitelist",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "trace-id"
                  }
                ]
              }
            ]
          }
        },
        {
          "key": "headersAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_container_data",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "use_google_credentials",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedScopes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://www.googleapis.com/auth/datastore"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios: []


___NOTES___

Created on 29.4.2025, 19:19:14


